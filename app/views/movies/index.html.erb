<div class="container">
  <h1>Movie Search</h1>
  <p class="subtitle">Search for movies by release date range</p>
  
  <!-- Search Form -->
  <%= form_with url: movies_index_path, method: :get, class: "search-form" do |form| %>
    <div class="form-group">
      <%= form.label :start_date, "Start Date (DD/MM/YYYY)" %>
      <%= form.text_field :start_date, value: params[:start_date], required: true, class: "form-control date-input", placeholder: "DD/MM/YYYY", pattern: "\\d{2}/\\d{2}/\\d{4}", maxlength: "10" %>
    </div>
    
    <div class="form-group">
      <%= form.label :end_date, "End Date (DD/MM/YYYY)" %>
      <%= form.text_field :end_date, value: params[:end_date], required: true, class: "form-control date-input", placeholder: "DD/MM/YYYY", pattern: "\\d{2}/\\d{2}/\\d{4}", maxlength: "10" %>
    </div>
    
    <div class="form-group">
      <%= form.label :sort_by, "Sort By" %>
      <%= form.select :sort_by, 
        options_for_select([
          ['Popularity', 'popularity'],
          ['Highest Rated', 'rating'],
          ['Most Voted', 'votes'],
          ['Newest First', 'newest'],
          ['Oldest First', 'oldest'],
          ['Alphabetical', 'alphabetical']
        ], params[:sort_by] || 'popularity'),
        {},
        class: "form-control" %>
    </div>
    
    <%= form.submit "Search Movies", class: "btn btn-primary" %>
  <% end %>
  
  <!-- Error Messages -->
  <% if @errors.any? %>
    <div class="errors">
      <% @errors.each do |error| %>
        <p class="error"><%= error %></p>
      <% end %>
    </div>
  <% end %>
  
  <!-- Results -->
  <% if params[:start_date].present? && @movies.present? %>
    <div class="results-header">
      <h2>Results</h2>
      <% 
        start_movie = (@current_page - 1) * 20 + 1
        end_movie = [@current_page * 20, @total_pages * 20].min
      %>
      <p class="results-count">Showing movies <%= start_movie %>-<%= end_movie %> of <%= @total_pages * 20 %> total (Page <%= @current_page %> of <%= @total_pages %>)</p>
    </div>
    
    <!-- Pagination Controls -->
    <% if @total_pages > 1 %>
      <div class="pagination">
        <%= link_to "¬´ First", movies_index_path(start_date: params[:start_date], end_date: params[:end_date], sort_by: params[:sort_by], page: 1), class: "pagination-link #{'disabled' if @current_page == 1}" unless @current_page == 1 %>
        <%= link_to "‚Äπ Prev", movies_index_path(start_date: params[:start_date], end_date: params[:end_date], sort_by: params[:sort_by], page: @current_page - 1), class: "pagination-link" if @current_page > 1 %>
        
        <% 
          start_page = [@current_page - 2, 1].max
          end_page = [@current_page + 2, @total_pages].min
          (start_page..end_page).each do |page_num|
        %>
          <%= link_to page_num, movies_index_path(start_date: params[:start_date], end_date: params[:end_date], sort_by: params[:sort_by], page: page_num), class: "pagination-link #{' active' if page_num == @current_page}" %>
        <% end %>
        
        <span class="page-jump">
          <label for="page-input">Go to:</label>
          <input type="number" id="page-input" min="1" max="<%= @total_pages %>" placeholder="<%= @current_page %>" style="width: 60px; padding: 5px; text-align: center;">
          <button onclick="goToPage()" class="pagination-link">Go</button>
        </span>
        
        <%= link_to "Next ‚Ä∫", movies_index_path(start_date: params[:start_date], end_date: params[:end_date], sort_by: params[:sort_by], page: @current_page + 1), class: "pagination-link" if @current_page < @total_pages %>
        <%= link_to "Last ¬ª", movies_index_path(start_date: params[:start_date], end_date: params[:end_date], sort_by: params[:sort_by], page: @total_pages), class: "pagination-link" if @current_page < @total_pages %>
      </div>
    <% end %>
    
    <div class="movies-grid">
      <% @movies.each do |movie| %>
        <% cache movie do %>
          <div class="movie-card" onclick="openModal(<%= movie.id %>)">
            <% if movie.poster_path.present? %>
              <img src="https://image.tmdb.org/t/p/w200<%= movie.poster_path %>" alt="<%= movie.title %>" class="movie-poster">
            <% else %>
              <div class="movie-poster-placeholder">No Image</div>
            <% end %>
            <div class="movie-info">
              <h3><%= movie.title %></h3>
              <p class="release-date"><strong>Release Date:</strong> <%= movie.release_date.strftime("%d/%m/%Y") %></p>
              <div class="movie-stats">
                <span class="stat" title="Average rating out of 10"><strong>‚≠ê</strong> <%= movie.vote_average&.round(1) || 'N/A' %></span>
                <span class="stat" title="Number of votes"><strong>üó≥Ô∏è</strong> <%= number_with_delimiter(movie.vote_count) if movie.vote_count %></span>
                <span class="stat" title="TMDb popularity score"><strong>üìà</strong> <%= movie.popularity&.round(1) %></span>
              </div>
              <p class="overview"><%= truncate(movie.overview, length: 150) %></p>
            </div>
          </div>

          <!-- Modal for movie details -->
          <div id="modal-<%= movie.id %>" class="modal">
            <div class="modal-content">
              <span class="modal-close" onclick="closeModal(<%= movie.id %>)">&times;</span>
              <div class="modal-body">
                <% if movie.poster_path.present? %>
                  <img src="https://image.tmdb.org/t/p/w300<%= movie.poster_path %>" alt="<%= movie.title %>" class="modal-poster">
                <% end %>
                <div class="modal-info">
                  <h2><%= movie.title %></h2>
                  <p class="modal-release-date"><strong>Release Date:</strong> <%= movie.release_date.strftime("%d/%m/%Y") %></p>
                  <div class="modal-stats">
                    <span class="stat"><strong>‚≠ê Rating:</strong> <%= movie.vote_average&.round(1) || 'N/A' %>/10</span>
                    <span class="stat"><strong>üó≥Ô∏è Votes:</strong> <%= number_with_delimiter(movie.vote_count) if movie.vote_count %></span>
                    <span class="stat"><strong>üìà Popularity:</strong> <%= movie.popularity&.round(1) %></span>
                  </div>
                  <h3>Overview</h3>
                  <p class="modal-overview"><%= movie.overview.presence || 'No overview available.' %></p>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  <% elsif params[:start_date].present? && @movies.empty? && @errors.empty? %>
    <p class="no-results">No movies found for the selected date range.</p>
  <% end %>
</div>

<script>
function goToPage() {
  const input = document.getElementById('page-input');
  const pageNum = parseInt(input.value);
  const maxPage = parseInt(input.max);
  const minPage = parseInt(input.min);
  
  if (isNaN(pageNum) || pageNum < minPage || pageNum > maxPage) {
    alert(`Please enter a valid page number between ${minPage} and ${maxPage}`);
    input.value = '';
    return;
  }
  
  const urlParams = new URLSearchParams(window.location.search);
  urlParams.set('page', pageNum);
  window.location.href = `${window.location.pathname}?${urlParams.toString()}`;
}

// Allow Enter key to trigger page jump
document.addEventListener('DOMContentLoaded', function() {
  const pageInput = document.getElementById('page-input');
  if (pageInput) {
    pageInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        goToPage();
      }
    });
  }
});

function openModal(movieId) {
  event.stopPropagation();
  const modal = document.getElementById('modal-' + movieId);
  if (modal) {
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }
}

function closeModal(movieId) {
  event.stopPropagation();
  const modal = document.getElementById('modal-' + movieId);
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
}

// Close modal when clicking outside of it
window.onclick = function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
      modal.style.display = 'none';
    });
    document.body.style.overflow = 'auto';
  }
});

// Auto-format date inputs as DD/MM/YYYY
document.addEventListener('DOMContentLoaded', function() {
  const dateInputs = document.querySelectorAll('.date-input');
  
  dateInputs.forEach(input => {
    let isDeleting = false;
    
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Backspace') {
        isDeleting = true;
        const cursorPos = e.target.selectionStart;
        const value = e.target.value;
        
        // If backspacing right after a slash, remove both the slash and the preceding digit
        if (cursorPos > 0 && value[cursorPos - 1] === '/') {
          e.preventDefault();
          const newValue = value.slice(0, cursorPos - 2) + value.slice(cursorPos);
          e.target.value = newValue;
          e.target.setSelectionRange(cursorPos - 2, cursorPos - 2);
          isDeleting = false; // Reset flag since deletion was handled manually
        }
      }
    });
    
    input.addEventListener('input', function(e) {
      const cursorPos = e.target.selectionStart;
      
      // When deleting, preserve the current structure without reformatting
      if (isDeleting) {
        isDeleting = false;
        e.target.setSelectionRange(cursorPos, cursorPos);
        return;
      }
      
      // When typing, format the input with slashes at positions 2 and 4
      let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
      
      if (value.length >= 2) {
        value = value.slice(0, 2) + '/' + value.slice(2);
      }
      if (value.length >= 5) {
        value = value.slice(0, 5) + '/' + value.slice(5, 9);
      }
      
      const oldLength = e.target.value.length;
      e.target.value = value;
      const newLength = value.length;
      
      // Adjust cursor position if a slash was automatically inserted
      if (newLength > oldLength) {
        e.target.setSelectionRange(cursorPos + 1, cursorPos + 1);
      } else {
        e.target.setSelectionRange(cursorPos, cursorPos);
      }
    });
    
    // Validate format on blur
    input.addEventListener('blur', function(e) {
      const value = e.target.value;
      if (value && !value.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
        e.target.setCustomValidity('Please enter date in DD/MM/YYYY format');
      } else {
        e.target.setCustomValidity('');
      }
    });
  });
});
</script>

